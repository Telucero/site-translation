name: Translate Documentation

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  TARGET_LANGUAGES: es fr
  DEFAULT_LANGUAGE: en
  PYTHON_VERSION: "3.11"

jobs:
  translate:
    runs-on: ubuntu-latest
    if: github.repository_owner != 'dependabot[bot]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate inputs
        run: |
          if [ -z "${{ secrets.N8N_WEBHOOK_URL_TR }}" ]; then
            echo "Secret N8N_WEBHOOK_URL_TR is required." >&2
            exit 1
          fi

      - name: Collect English documentation changes
        id: changes
        run: |
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
          if [ "$BASE" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE" ]; then
            BASE=$(git rev-list --max-parents=0 "$HEAD")
          fi

          git diff --name-only "$BASE" "$HEAD" -- ':(glob)docs/${{ env.DEFAULT_LANGUAGE }}/**/*.md' > english_changes.txt || true
          # Remove empty lines to avoid passing blank arguments
          sed -i '/^$/d' english_changes.txt || true
          CHANGED_COUNT=$(wc -l < english_changes.txt || echo 0)

          echo "count=$CHANGED_COUNT" >> "$GITHUB_OUTPUT"
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat english_changes.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Request translations via n8n
        if: steps.changes.outputs.count != '0'
        env:
          N8N_WEBHOOK_URL_TR: ${{ secrets.N8N_WEBHOOK_URL_TR }}
          DEFAULT_LANGUAGE: ${{ env.DEFAULT_LANGUAGE }}
          TARGET_LANGUAGES: ${{ env.TARGET_LANGUAGES }}
        run: |
          if [ -z "$N8N_WEBHOOK_URL_TR" ]; then
            echo "Missing N8N_WEBHOOK_URL_TR secret" >&2
            exit 1
          fi
          mapfile -t FILE_LIST < english_changes.txt
          python scripts/request_translation.py "${FILE_LIST[@]}" \
            --webhook-url "$N8N_WEBHOOK_URL_TR" \
            --languages $TARGET_LANGUAGES \
            --default-language "$DEFAULT_LANGUAGE" \
            --branch "${{ github.ref }}" \
            --commit "${{ github.sha }}"

      - name: Ensure translations written
        if: steps.changes.outputs.count != '0'
        run: |
          if git diff --quiet --exit-code; then
            echo "No localized files were generated by n8n response." >&2
            exit 1
          fi

      - name: Build MkDocs site
        run: mkdocs build

      - name: Commit localized updates
        if: steps.changes.outputs.count != '0'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update localized docs"
          branch: ${{ github.ref_name }}
