name: Translate Documentation

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  TARGET_LANGUAGES: es fr pt
  DEFAULT_LANGUAGE: en
  PYTHON_VERSION: "3.11"
  FORCED_TRANSLATION_FILES: |-
    docs/en/learn/framework/overview.md
    docs/en/learn/framework/modules.md

jobs:
  translate:
    runs-on: ubuntu-latest
    if: github.repository_owner != 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      


      - name: Validate inputs
        run: |
          if [ -z "${{ secrets.N8N_WEBHOOK_URL_TR }}" ]; then
            echo "Secret N8N_WEBHOOK_URL_TR is required." >&2
            exit 1
          fi

      - name: Collect English documentation changes
        id: changes
        run: |
          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"
          if [ "$BASE" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE" ]; then
            BASE=$(git rev-list --max-parents=0 "$HEAD")
          fi

          git diff --name-only "$BASE" "$HEAD" -- ':(glob)tanssi-mkdocs/docs/${{ env.DEFAULT_LANGUAGE }}/**/*.md' > english_changes.txt || true
          sed -i 's#^tanssi-mkdocs/docs/#docs/#' english_changes.txt || true
          # Remove empty lines to avoid passing blank arguments
          sed -i '/^$/d' english_changes.txt || true
          CHANGED_COUNT=$(wc -l < english_changes.txt || echo 0)

          echo "count=$CHANGED_COUNT" >> "$GITHUB_OUTPUT"
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat english_changes.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Detect missing localized docs
        id: missing
        env:
          DEFAULT_LANGUAGE: ${{ env.DEFAULT_LANGUAGE }}
          TARGET_LANGUAGES: ${{ env.TARGET_LANGUAGES }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          default_lang = os.environ["DEFAULT_LANGUAGE"]
          target_langs = [lang.strip() for lang in os.environ["TARGET_LANGUAGES"].split() if lang.strip()]
          repo = Path(".").resolve()
          docs_root = repo / "tanssi-mkdocs" / "docs"
          english_root = docs_root / default_lang
          if not english_root.exists():
              raise SystemExit(f"Expected directory {english_root} to exist.")

          missing = set()
          for src in english_root.rglob("*.md"):
              rel = src.relative_to(english_root)
              rel_en = Path("docs") / default_lang / rel
              for lang in target_langs:
                  localized = docs_root / lang / rel
                  if not localized.exists():
                      missing.add(str(rel_en))
                      break

          missing_file = Path("missing_docs.txt")
          if missing:
              missing_file.write_text("\n".join(sorted(missing)), encoding="utf-8")
              print(f"Missing localized docs detected: {len(missing)}")
          else:
              missing_file.write_text("", encoding="utf-8")
              print("All localized docs present.")
          PY

          MISSING_COUNT=$(if [ -f missing_docs.txt ]; then wc -l < missing_docs.txt; else echo 0; fi)
          echo "count=${MISSING_COUNT:-0}" >> "$GITHUB_OUTPUT"

      - name: Build translation target list
        id: targets
        run: |
          : > translation_targets.txt
          if [ -f english_changes.txt ]; then
            cat english_changes.txt >> translation_targets.txt
          fi
          if [ -f missing_docs.txt ]; then
            cat missing_docs.txt >> translation_targets.txt
          fi
          if [ -n "${FORCED_TRANSLATION_FILES}" ]; then
            if [ -s translation_targets.txt ]; then
              printf '\n' >> translation_targets.txt
            fi
            printf '%s\n' "${FORCED_TRANSLATION_FILES}" >> translation_targets.txt
          fi
          # Normalise, drop blanks, dedupe
          sort -u translation_targets.txt -o translation_targets.txt || true
          sed -i '/^$/d' translation_targets.txt || true
          TARGET_COUNT=$(if [ -s translation_targets.txt ]; then wc -l < translation_targets.txt; else echo 0; fi)
          echo "count=$TARGET_COUNT" >> "$GITHUB_OUTPUT"
          if [ "$TARGET_COUNT" -gt 0 ]; then
            echo "Translation targets:"
            cat translation_targets.txt
          else
            echo "No translation work required."
          fi

      - name: Request translations via n8n
        if: steps.targets.outputs.count != '0'
        env:
          N8N_WEBHOOK_URL_TR: ${{ secrets.N8N_WEBHOOK_URL_TR }}
          DEFAULT_LANGUAGE: ${{ env.DEFAULT_LANGUAGE }}
          TARGET_LANGUAGES: ${{ env.TARGET_LANGUAGES }}
        run: |
          if [ -z "$N8N_WEBHOOK_URL_TR" ]; then
            echo "Missing N8N_WEBHOOK_URL_TR secret" >&2
            exit 1
          fi
          mapfile -t FILE_LIST < translation_targets.txt
          python scripts/request_translation.py "${FILE_LIST[@]}" \
            --webhook-url "$N8N_WEBHOOK_URL_TR" \
            --languages $TARGET_LANGUAGES \
            --default-language "$DEFAULT_LANGUAGE" \
            --branch "${{ github.ref }}" \
            --commit "${{ github.sha }}"

      - name: Commit forced translations to current branch
        if: steps.targets.outputs.count != '0'
        env:
          TARGET_LANGUAGES: ${{ env.TARGET_LANGUAGES }}
          DEFAULT_LANGUAGE: ${{ env.DEFAULT_LANGUAGE }}
          FORCED_TRANSLATION_FILES: ${{ env.FORCED_TRANSLATION_FILES }}
          BASE_BRANCH: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${FORCED_TRANSLATION_FILES}" ]; then
            echo "No forced translation files configured."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          staged=0
          while IFS= read -r forced_file; do
            [ -z "$forced_file" ] && continue

            case "$forced_file" in
              docs/${DEFAULT_LANGUAGE}/*) suffix="${forced_file#docs/${DEFAULT_LANGUAGE}/}" ;;
              docs/*) suffix="${forced_file#docs/}" ;;
              *)
                echo "Skipping forced path '$forced_file' (expected under docs/)."
                continue
                ;;
            esac

            for lang in $TARGET_LANGUAGES; do
              localized="tanssi-mkdocs/docs/${lang}/${suffix}"
              if [ -f "$localized" ]; then
                git add "$localized"
                staged=1
              else
                echo "Localized file not found for $lang: $localized"
              fi
            done
          done <<'EOF'
          ${{ env.FORCED_TRANSLATION_FILES }}
          EOF

          if [ "$staged" -eq 0 ]; then
            echo "No forced translation files to commit."
            git reset --quiet
            exit 0
          fi

          if git diff --cached --quiet; then
            echo "Forced translation files staged but no differences detected."
            git reset --quiet
            exit 0
          fi

          git commit -m "chore: update forced translations"
          git push origin HEAD:"$BASE_BRANCH"

      - name: Cleanup temporary files
        if: ${{ always() }}
        run: rm -f english_changes.txt missing_docs.txt translation_targets.txt

      - name: Report localized diff
        if: steps.targets.outputs.count != '0'
        run: |
          if git diff --quiet --exit-code; then
            echo "::warning ::No localized files were generated by n8n response."
          else
            git status -sb
          fi

      - name: Build MkDocs site
        if: steps.targets.outputs.count != '0'
        run: mkdocs build --config-file tanssi-mkdocs/mkdocs.yml

      - name: Publish localized branches and PRs
        if: steps.targets.outputs.count != '0'
        env:
          TARGET_LANGUAGES: ${{ env.TARGET_LANGUAGES }}
          BASE_BRANCH: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          PATCH_ROOT="${RUNNER_TEMP}/translation-patches"
          mkdir -p "$PATCH_ROOT"

          LANG_LIST="$PATCH_ROOT/langs.txt"
          : > "$LANG_LIST"

          for lang in $TARGET_LANGUAGES; do
            if git diff --quiet --exit-code -- "tanssi-mkdocs/docs/$lang/"; then
              echo "No updates detected for $lang; skipping patch capture."
              continue
            fi
            patch_file="$PATCH_ROOT/$lang.patch"
            git diff --binary -- "tanssi-mkdocs/docs/$lang" > "$patch_file"
            if [ ! -s "$patch_file" ]; then
              rm -f "$patch_file"
              continue
            fi
            echo "$lang" >> "$LANG_LIST"
          done

          if [ ! -s "$LANG_LIST" ]; then
            echo "No localized changes present; skipping branch publication."
            exit 0
          fi

          # Return the working tree to a clean state before we branch off.
          git checkout -- .

          while IFS= read -r lang; do
            patch_file="$PATCH_ROOT/$lang.patch"
            branch="${lang}/${BASE_BRANCH}"
            echo "::group::Preparing branch $branch"
            git checkout -B "$branch" "$BASE_BRANCH"
            git apply "$patch_file"
            git add "tanssi-mkdocs/docs/$lang"
            if git diff --cached --quiet; then
              echo "No staged changes for $lang; skipping branch creation."
              git checkout "$BASE_BRANCH"
              echo "::endgroup::"
              continue
            fi
            git commit -m "chore(${lang}): update localized docs"
            git push --force-with-lease origin "$branch"

            if gh pr view --head "$branch" >/dev/null 2>&1; then
              gh pr edit "$branch" \
                --title "chore(${lang}): update localized docs" \
                --body "Automated translation update for \`$lang\` sourced from branch \`$BASE_BRANCH\`."
            else
              gh pr create \
                --base "$BASE_BRANCH" \
                --head "$branch" \
                --title "chore(${lang}): update localized docs" \
                --body "Automated translation update for \`$lang\` sourced from branch \`$BASE_BRANCH\`."
            fi
            git checkout "$BASE_BRANCH"
            echo "::endgroup::"
          done < "$LANG_LIST"

          git checkout "$BASE_BRANCH"
          git reset --hard "$BASE_BRANCH"
